extends CanvasLayer
class_name SettingsMenu

## Settings menu UI - volume controls and graphics options

@onready var panel: PanelContainer = $Panel
@onready var title_label: Label = $Panel/MarginContainer/VBoxContainer/Title
@onready var master_slider: HSlider = $Panel/MarginContainer/VBoxContainer/AudioSettings/MasterVolume/Slider
@onready var master_value_label: Label = $Panel/MarginContainer/VBoxContainer/AudioSettings/MasterVolume/ValueLabel
@onready var music_slider: HSlider = $Panel/MarginContainer/VBoxContainer/AudioSettings/MusicVolume/Slider
@onready var music_value_label: Label = $Panel/MarginContainer/VBoxContainer/AudioSettings/MusicVolume/ValueLabel
@onready var sfx_slider: HSlider = $Panel/MarginContainer/VBoxContainer/AudioSettings/SFXVolume/Slider
@onready var sfx_value_label: Label = $Panel/MarginContainer/VBoxContainer/AudioSettings/SFXVolume/ValueLabel
@onready var vsync_checkbox: CheckBox = $Panel/MarginContainer/VBoxContainer/GraphicsSettings/VSync/CheckBox
@onready var fullscreen_checkbox: CheckBox = $Panel/MarginContainer/VBoxContainer/GraphicsSettings/Fullscreen/CheckBox
@onready var shadow_quality_option: OptionButton = $Panel/MarginContainer/VBoxContainer/GraphicsSettings/ShadowQuality/OptionButton
@onready var show_fps_checkbox: CheckBox = $Panel/MarginContainer/VBoxContainer/GraphicsSettings/ShowFPS/CheckBox
@onready var back_button: Button = $Panel/MarginContainer/VBoxContainer/BackButton

var is_open: bool = false
var return_to_menu: Node = null  # Reference to the menu that opened settings
var fps_display: Node = null  # Reference to FPS display
var currently_focused_button: Button = null  # Track keyboard-focused button

# Audio bus indices
const MASTER_BUS := 0
const MUSIC_BUS := 1
const SFX_BUS := 2

func _ready() -> void:
	# Connect sliders
	if master_slider:
		master_slider.value_changed.connect(_on_master_volume_changed)
	if music_slider:
		music_slider.value_changed.connect(_on_music_volume_changed)
	if sfx_slider:
		sfx_slider.value_changed.connect(_on_sfx_volume_changed)

	# Connect checkboxes
	if vsync_checkbox:
		vsync_checkbox.toggled.connect(_on_vsync_toggled)
	if fullscreen_checkbox:
		fullscreen_checkbox.toggled.connect(_on_fullscreen_toggled)
	if show_fps_checkbox:
		show_fps_checkbox.toggled.connect(_on_show_fps_toggled)

	# Connect option button
	if shadow_quality_option:
		shadow_quality_option.item_selected.connect(_on_shadow_quality_selected)

	# Find FPS display
	await get_tree().process_frame
	fps_display = get_tree().get_first_node_in_group("fps_display")

	# Connect back button (with focus animations)
	if back_button:
		print("[SETTINGS] Connecting back button...")
		back_button.pressed.connect(_on_back_pressed)
		back_button.focus_entered.connect(_on_button_focus_entered.bind(back_button))
		back_button.focus_exited.connect(_on_button_focus_exited.bind(back_button))
		back_button.mouse_entered.connect(_on_button_hover.bind(back_button))
		back_button.mouse_exited.connect(_on_button_unhover.bind(back_button))
		print("[SETTINGS] Back button connected successfully!")
	else:
		push_warning("[SETTINGS] Back button node not found!")

	# Load settings
	_load_settings()

	# Start hidden
	visible = false

func _input(event: InputEvent) -> void:
	if not is_open:
		return

	# Close with Escape
	if event.is_action_pressed("ui_cancel"):
		_on_back_pressed()
		get_viewport().set_input_as_handled()

func show_settings(caller: Node = null) -> void:
	"""Show the settings menu."""
	is_open = true
	visible = true
	return_to_menu = caller

	# Show mouse cursor
	Input.set_mouse_mode(Input.MOUSE_MODE_VISIBLE)

	# Pause if not already paused
	if not get_tree().paused:
		get_tree().paused = true

	# Focus first control
	if master_slider:
		master_slider.grab_focus()

func hide_settings() -> void:
	"""Hide the settings menu."""
	print("[SETTINGS] hide_settings() called")
	is_open = false
	visible = false

	# Save settings
	_save_settings()

	# Unpause the game tree if we paused it
	# Main menu will handle pausing if needed
	if get_tree().paused:
		print("[SETTINGS] Unpausing game tree")
		get_tree().paused = false

	# Restore mouse cursor state based on caller
	# If returning to pause menu or main menu, keep cursor visible
	# If returning to gameplay, hide cursor
	if return_to_menu:
		print("[SETTINGS] Returning to menu: ", return_to_menu.name)
		# Keep cursor visible for menus
		Input.set_mouse_mode(Input.MOUSE_MODE_VISIBLE)
	else:
		print("[SETTINGS] No return menu, hiding cursor")
		# Hide cursor when returning to gameplay
		Input.set_mouse_mode(Input.MOUSE_MODE_CAPTURED)

	# Notify the caller
	if return_to_menu and return_to_menu.has_method("on_settings_closed"):
		print("[SETTINGS] Calling on_settings_closed() on ", return_to_menu.name)
		return_to_menu.on_settings_closed()
	else:
		print("[SETTINGS] No return_to_menu or no on_settings_closed method")

	return_to_menu = null
	print("[SETTINGS] Settings menu hidden")

func _load_settings() -> void:
	"""Load settings from config file or set defaults."""
	# Audio settings (check if buses exist)
	var bus_count := AudioServer.bus_count
	var master_volume := 1.0 if bus_count <= MASTER_BUS else _db_to_linear(AudioServer.get_bus_volume_db(MASTER_BUS))
	var music_volume := 0.7 if bus_count <= MUSIC_BUS else _db_to_linear(AudioServer.get_bus_volume_db(MUSIC_BUS))
	var sfx_volume := 0.8 if bus_count <= SFX_BUS else _db_to_linear(AudioServer.get_bus_volume_db(SFX_BUS))

	if master_slider:
		master_slider.value = master_volume * 100.0
		_update_volume_label(master_value_label, master_volume)
	if music_slider:
		music_slider.value = music_volume * 100.0
		_update_volume_label(music_value_label, music_volume)
	if sfx_slider:
		sfx_slider.value = sfx_volume * 100.0
		_update_volume_label(sfx_value_label, sfx_volume)

	# Graphics settings
	if vsync_checkbox:
		vsync_checkbox.button_pressed = DisplayServer.window_get_vsync_mode() != DisplayServer.VSYNC_DISABLED
	if fullscreen_checkbox:
		fullscreen_checkbox.button_pressed = (
			DisplayServer.window_get_mode() == DisplayServer.WINDOW_MODE_FULLSCREEN or
			DisplayServer.window_get_mode() == DisplayServer.WINDOW_MODE_EXCLUSIVE_FULLSCREEN
		)

	# Shadow quality (default to medium - index 1)
	if shadow_quality_option:
		shadow_quality_option.selected = 1

	# FPS display (default to enabled)
	if show_fps_checkbox:
		show_fps_checkbox.button_pressed = fps_display and fps_display.is_visible

func _save_settings() -> void:
	"""Save settings to config file."""
	# TODO: Implement config file saving
	# For now, settings are applied in real-time and persist in the audio server
	pass

func _on_master_volume_changed(value: float) -> void:
	"""Called when master volume slider changes."""
	var linear_value := value / 100.0
	if AudioServer.bus_count > MASTER_BUS:
		AudioServer.set_bus_volume_db(MASTER_BUS, _linear_to_db(linear_value))
	_update_volume_label(master_value_label, linear_value)

func _on_music_volume_changed(value: float) -> void:
	"""Called when music volume slider changes."""
	var linear_value := value / 100.0
	if AudioServer.bus_count > MUSIC_BUS:
		AudioServer.set_bus_volume_db(MUSIC_BUS, _linear_to_db(linear_value))
	_update_volume_label(music_value_label, linear_value)

func _on_sfx_volume_changed(value: float) -> void:
	"""Called when SFX volume slider changes."""
	var linear_value := value / 100.0
	if AudioServer.bus_count > SFX_BUS:
		AudioServer.set_bus_volume_db(SFX_BUS, _linear_to_db(linear_value))
	_update_volume_label(sfx_value_label, linear_value)

	# Play a test sound
	if AudioManager.instance:
		AudioManager.instance.play_sfx("order_ding")

func _on_vsync_toggled(enabled: bool) -> void:
	"""Called when VSync checkbox is toggled."""
	if enabled:
		DisplayServer.window_set_vsync_mode(DisplayServer.VSYNC_ENABLED)
	else:
		DisplayServer.window_set_vsync_mode(DisplayServer.VSYNC_DISABLED)

func _on_fullscreen_toggled(enabled: bool) -> void:
	"""Called when fullscreen checkbox is toggled."""
	if enabled:
		DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_FULLSCREEN)
	else:
		DisplayServer.window_set_mode(DisplayServer.WINDOW_MODE_WINDOWED)

func _on_shadow_quality_selected(index: int) -> void:
	"""Called when shadow quality option is selected."""
	# TODO: Implement shadow quality changes
	# This would require modifying RenderingServer settings
	match index:
		0:  # Low
			print("Shadow quality set to Low")
		1:  # Medium
			print("Shadow quality set to Medium")
		2:  # High
			print("Shadow quality set to High")
		3:  # Ultra
			print("Shadow quality set to Ultra")

func _on_show_fps_toggled(enabled: bool) -> void:
	"""Called when Show FPS checkbox is toggled."""
	if fps_display and fps_display.has_method("show_fps") and fps_display.has_method("hide_fps"):
		if enabled:
			fps_display.show_fps()
		else:
			fps_display.hide_fps()

func _on_back_pressed() -> void:
	"""Called when back button is pressed."""
	print("[SETTINGS] Back button pressed!")
	hide_settings()

func _update_volume_label(label: Label, value: float) -> void:
	"""Update a volume label with the current percentage."""
	if label:
		label.text = "%d%%" % int(value * 100.0)

func _linear_to_db(linear: float) -> float:
	"""Convert linear volume (0-1) to decibels."""
	if linear <= 0.0:
		return -80.0
	return 20.0 * log(linear) / log(10.0)

func _db_to_linear(db: float) -> float:
	"""Convert decibels to linear volume (0-1)."""
	if db <= -80.0:
		return 0.0
	return pow(10.0, db / 20.0)

# Button animation functions (same as MainMenu)
func _on_button_hover(button: Button) -> void:
	"""Add scale effect on mouse hover."""
	# When mouse enters a button, transfer focus to it (for better UX)
	if button.has_method("grab_focus"):
		button.grab_focus()

	# Kill any existing scale tween
	if button.has_meta("scale_tween"):
		var old_tween = button.get_meta("scale_tween")
		if old_tween:
			old_tween.kill()

	var tween = create_tween()
	tween.set_ease(Tween.EASE_OUT)
	tween.set_trans(Tween.TRANS_ELASTIC)
	tween.tween_property(button, "scale", Vector2(1.05, 1.05), 0.3)
	button.set_meta("scale_tween", tween)

	# Also enlarge text inside button
	_enlarge_button_text(button)

func _on_button_unhover(button: Button) -> void:
	"""Reset scale when mouse leaves (only if not focused via keyboard)."""
	if button != currently_focused_button:
		# Kill any existing scale tween
		if button.has_meta("scale_tween"):
			var old_tween = button.get_meta("scale_tween")
			if old_tween:
				old_tween.kill()

		var tween = create_tween()
		tween.set_ease(Tween.EASE_OUT)
		tween.tween_property(button, "scale", Vector2(1.0, 1.0), 0.2)
		button.set_meta("scale_tween", tween)

		_reset_button_text(button)

func _on_button_focus_entered(button: Button) -> void:
	"""Keyboard focus entered - prominent visual feedback."""
	currently_focused_button = button

	# Kill any existing scale tween
	if button.has_meta("scale_tween"):
		var old_tween = button.get_meta("scale_tween")
		if old_tween:
			old_tween.kill()

	var tween = create_tween()
	tween.set_ease(Tween.EASE_OUT)
	tween.set_trans(Tween.TRANS_ELASTIC)
	tween.tween_property(button, "scale", Vector2(1.1, 1.1), 0.4)
	button.set_meta("scale_tween", tween)

	# Enlarge button text prominently
	_enlarge_button_text(button, 1.2)  # More prominent for keyboard focus

	# Add pulsing glow effect
	_start_button_pulse(button)

func _on_button_focus_exited(button: Button) -> void:
	"""Keyboard focus lost - reset."""
	if currently_focused_button == button:
		currently_focused_button = null

	# Stop pulse and reset
	_stop_button_pulse(button)

	# Kill any existing scale tween
	if button.has_meta("scale_tween"):
		var old_tween = button.get_meta("scale_tween")
		if old_tween:
			old_tween.kill()

	var tween = create_tween()
	tween.set_ease(Tween.EASE_OUT)
	tween.tween_property(button, "scale", Vector2(1.0, 1.0), 0.3)
	button.set_meta("scale_tween", tween)

	_reset_button_text(button)

func _start_button_pulse(button: Button) -> void:
	"""Start pulsing glow effect on focused button."""
	var tween = create_tween()
	tween.set_loops()
	tween.set_ease(Tween.EASE_IN_OUT)
	tween.tween_property(button, "modulate:a", 0.7, 0.8)
	tween.tween_property(button, "modulate:a", 1.0, 0.8)
	button.set_meta("pulse_tween", tween)

func _stop_button_pulse(button: Button) -> void:
	"""Stop pulsing effect."""
	if button.has_meta("pulse_tween"):
		var tween = button.get_meta("pulse_tween")
		if tween:
			tween.kill()
		button.remove_meta("pulse_tween")
	button.modulate.a = 1.0

func _enlarge_button_text(button: Button, scale_factor: float = 1.15) -> void:
	"""Enlarge the text/label inside a button."""
	# Kill any existing text tween
	if button.has_meta("text_tween"):
		var old_tween = button.get_meta("text_tween")
		if old_tween:
			old_tween.kill()

	# Get original size (Back button is 28px)
	var original_size = 28
	var target_size = int(original_size * scale_factor)

	var tween = create_tween()
	tween.set_ease(Tween.EASE_OUT)
	tween.set_trans(Tween.TRANS_BACK)
	tween.tween_property(button, "theme_override_font_sizes/font_size", target_size, 0.2)
	button.set_meta("text_tween", tween)

func _reset_button_text(button: Button) -> void:
	"""Reset button text to original size."""
	# Kill any existing text tween
	if button.has_meta("text_tween"):
		var old_tween = button.get_meta("text_tween")
		if old_tween:
			old_tween.kill()

	var original_size = 28
	var tween = create_tween()
	tween.set_ease(Tween.EASE_OUT)
	tween.tween_property(button, "theme_override_font_sizes/font_size", original_size, 0.15)
	button.set_meta("text_tween", tween)
